generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CONTRACTOR
  CLIENT
  MANAGER
}

enum UserStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  password       String
  name           String?
  role           UserRole   @default(CONTRACTOR)
  status         UserStatus @default(PENDING)
  emailVerified  DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Contractor-specific relations
  contractor     Contractor?
  
  // Client-specific relations
  client         Client?

  // Manager-specific relations (created by clients to manage branches)
  manager        Manager?
}

model Contractor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName   String?
  companyPhone  String?
  companyEmail  String?
  companyAddress String?
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clients       Client[]
}

model Client {
  id            String     @id @default(cuid())
  userId        String     @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  companyName   String
  companyPhone  String?
  companyEmail  String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  branches      Branch[]
  managers      Manager[]  // Managers created by this client
}

model Branch {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  address     String
  city        String?
  state       String?
  zipCode     String?
  country     String?
  phone       String?
  notes       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Manager access - which managers can access this branch
  managerAccess BranchManager[]
  
  // Module relations
  requests    Request[]
}

// Request priorities and statuses
enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Service Request - created by contractor or client for a branch
model Request {
  id          String          @id @default(cuid())
  branchId    String
  branch      Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  title       String
  description String?
  priority    RequestPriority @default(MEDIUM)
  status      RequestStatus   @default(OPEN)
  createdById String
  createdByRole UserRole
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Manager - created by clients to manage specific branches
model Manager {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  jobTitle    String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Which branches this manager can access
  branchAccess BranchManager[]
}

// Junction table for Manager <-> Branch many-to-many relationship
model BranchManager {
  id         String   @id @default(cuid())
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  managerId  String
  manager    Manager  @relation(fields: [managerId], references: [id], onDelete: Cascade)
  canEdit    Boolean  @default(true)  // Can edit requests, quotes, etc.
  canApprove Boolean  @default(false) // Can approve quotes, payments
  createdAt  DateTime @default(now())

  @@unique([branchId, managerId])
}
