generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CONTRACTOR
  CLIENT
  MANAGER
}

enum UserStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  password       String
  name           String?
  role           UserRole   @default(CONTRACTOR)
  status         UserStatus @default(PENDING)
  emailVerified  DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Contractor-specific relations
  contractor     Contractor?
  
  // Client-specific relations
  client         Client?

  // Manager-specific relations (created by clients to manage branches)
  manager        Manager?
}

model Contractor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName   String?
  companyPhone  String?
  companyEmail  String?
  companyAddress String?
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clients       Client[]
}

model Client {
  id            String     @id @default(cuid())
  userId        String     @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  companyName   String
  companyPhone  String?
  companyEmail  String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  branches      Branch[]
  managers      Manager[]  // Managers created by this client
}

model Branch {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  address     String
  city        String?
  state       String?
  zipCode     String?
  country     String?
  phone       String?
  notes       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Manager access - which managers can access this branch
  managerAccess BranchManager[]
  
  // Module relations
  requests     Request[]
  quotations   Quotation[]
  appointments Appointment[]
  invoices     Invoice[]
}

// Request priorities and statuses
enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Service Request - created by contractor or client for a branch
model Request {
  id          String          @id @default(cuid())
  branchId    String
  branch      Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  title       String
  description String?
  priority    RequestPriority @default(MEDIUM)
  status      RequestStatus   @default(OPEN)
  createdById String
  createdByRole UserRole
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Quotation statuses
enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
}

// Quotation - created by contractor for client approval
model Quotation {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  requestId     String?
  title         String
  description   String?
  items         QuotationItem[]
  subtotal      Float           @default(0)
  taxRate       Float           @default(0)
  taxAmount     Float           @default(0)
  total         Float           @default(0)
  status        QuotationStatus @default(DRAFT)
  validUntil    DateTime?
  sentAt        DateTime?
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  rejectionNote String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Quotation line items
model QuotationItem {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  description String
  quantity    Float     @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Appointment statuses
enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

// Appointment - scheduled visits/inspections
model Appointment {
  id              String            @id @default(cuid())
  branchId        String
  branch          Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  title           String
  description     String?
  date            DateTime
  startTime       String
  endTime         String?
  duration        Int?              // Duration in minutes
  assignedTo      String?
  status          AppointmentStatus @default(SCHEDULED)
  confirmedAt     DateTime?
  confirmedById   String?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelledById   String?
  cancellationNote String?
  rescheduleNote  String?
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

// Invoice statuses
enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// Invoice - created by contractor for payment
model Invoice {
  id            String        @id @default(cuid())
  branchId      String
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  quotationId   String?
  invoiceNumber String
  title         String
  description   String?
  items         InvoiceItem[]
  subtotal      Float         @default(0)
  taxRate       Float         @default(0)
  taxAmount     Float         @default(0)
  total         Float         @default(0)
  amountPaid    Float         @default(0)
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  sentAt        DateTime?
  paidAt        DateTime?
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// Invoice line items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Manager - created by clients to manage specific branches
model Manager {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  jobTitle    String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Which branches this manager can access
  branchAccess BranchManager[]
}

// Junction table for Manager <-> Branch many-to-many relationship
model BranchManager {
  id         String   @id @default(cuid())
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  managerId  String
  manager    Manager  @relation(fields: [managerId], references: [id], onDelete: Cascade)
  canEdit    Boolean  @default(true)  // Can edit requests, quotes, etc.
  canApprove Boolean  @default(false) // Can approve quotes, payments
  createdAt  DateTime @default(now())

  @@unique([branchId, managerId])
}
