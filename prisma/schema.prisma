generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CONTRACTOR
  CLIENT
  TEAM_MEMBER
}

enum TeamMemberRole {
  SUPERVISOR
  TECHNICIAN
}

enum UserStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

enum BusinessType {
  LLC
  CORPORATION
  SOLE_PROPRIETOR
  PARTNERSHIP
  JOINT_VENTURE
  GOVERNMENT
  NON_PROFIT
  OTHER
}

// Issue types for service requests
enum IssueType {
  // Fire Alarm
  ALARM_FAULT
  FALSE_ALARM
  PANEL_ERROR
  ZONE_FAULT
  BATTERY_ISSUE
  
  // Suppression
  SPRINKLER_LEAK
  SPRINKLER_DAMAGE
  PIPE_LEAK
  VALVE_ISSUE
  PUMP_PROBLEM
  
  // Extinguishers
  EXTINGUISHER_REFILL
  EXTINGUISHER_REPLACEMENT
  EXTINGUISHER_EXPIRED
  EXTINGUISHER_MISSING
  
  // Detection
  SMOKE_DETECTOR_FAULT
  HEAT_DETECTOR_FAULT
  GAS_DETECTOR_ISSUE
  DETECTOR_REPLACEMENT
  
  // Emergency Systems
  EMERGENCY_LIGHT_FAULT
  EXIT_SIGN_FAULT
  FIRE_DOOR_ISSUE
  EMERGENCY_EXIT_BLOCKED
  
  // Maintenance & Inspection
  SCHEDULED_INSPECTION
  PREVENTIVE_MAINTENANCE
  ANNUAL_CERTIFICATION
  SYSTEM_TESTING
  
  // Other
  GENERAL_INQUIRY
  QUOTE_REQUEST
  NEW_INSTALLATION
  OTHER
}

// Work order types
enum WorkOrderType {
  SERVICE           // Repair, fix issues
  INSPECTION        // Check systems, compliance
  MAINTENANCE       // Preventive maintenance
  INSTALLATION      // New equipment
  OTHER
}

// Certificate types
enum CertificateType {
  PREVENTIVE_MAINTENANCE
  COMPLETION
  COMPLIANCE
  INSPECTION
  CIVIL_DEFENSE     // Uploaded external
}

enum BuildingType {
  OFFICE
  RETAIL
  WAREHOUSE
  INDUSTRIAL
  RESIDENTIAL
  HOSPITAL
  EDUCATIONAL
  HOTEL
  RESTAURANT
  MALL
  MIXED_USE
  PARKING
  MOSQUE
  GOVERNMENT
  SPORTS
  DATA_CENTER
  OTHER
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  password       String
  name           String?
  role           UserRole   @default(CONTRACTOR)
  status         UserStatus @default(PENDING)
  emailVerified  DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Contractor-specific relations
  contractor     Contractor?
  
  // Client-specific relations
  client         Client?

  // Team member-specific relations
  teamMember     TeamMember?
  
  // Request comments
  requestComments RequestComment[]
}

model Contractor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName   String?
  companyPhone  String?
  companyEmail  String?
  companyAddress String?
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Company Profile Fields
  logoUrl           String?       // Company logo
  website           String?       // Company website
  businessType      BusinessType? // LLC, Corporation, etc.
  yearEstablished   Int?          // Year company was founded
  
  // Registration & Licensing (KSA: CR, US: Business License)
  crNumber          String?       // Commercial Registration (KSA) / Business License (US)
  vatNumber         String?       // VAT Number (KSA) / EIN (US)
  
  // Civil Defense / State License
  licenseNumber     String?       // Civil Defense License (KSA) / State Contractor License (US)
  licenseExpiry     DateTime?     // License expiration date
  
  // Insurance
  insuranceCertUrl  String?       // Insurance certificate document URL
  insuranceExpiry   DateTime?     // Insurance expiration date
  
  // Service Areas
  serviceAreas      Json?         // Array of cities/regions served

  // Relations
  clients       Client[]
  teamMembers   TeamMember[]
}

model Client {
  id            String     @id @default(cuid())
  userId        String     @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  companyName   String
  companyPhone  String?
  companyEmail  String?
  
  // New profile fields
  crNumber            String?    // Commercial Registration number
  vatNumber           String?    // VAT registration number
  billingAddress      String?    // Billing/invoice address
  contacts            Json?      // Array of contact persons: [{name, phone, email, whatsapp}]
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  branches        Branch[]
  branchRequests  BranchRequest[]
}

model Branch {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  address     String
  city        String?
  state       String?
  zipCode     String?
  country     String?
  phone       String?
  notes       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean  @default(true)
  
  // New facility profile fields
  municipality          String?       // Municipality / Civil Defense region
  buildingType          BuildingType? // Type of building
  floorCount            Int?          // Number of floors
  areaSize              Float?        // Area in square meters
  cdCertificateNumber   String?       // Civil Defense certificate number
  cdCertificateExpiry   DateTime?     // When CD certificate expires
  cdCertificateUrl      String?       // Uploaded certificate file URL
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Module relations
  projects     Project[]
  requests     Request[]
  quotations   Quotation[]
  appointments Appointment[]
  invoices     Invoice[]
  contracts    Contract[]
  checklists   Checklist[]
  certificates Certificate[]

  // Team member access
  teamMemberAccess TeamMemberBranch[]
}

// Project statuses - simplified for contract lifecycle
enum ProjectStatus {
  PENDING    // Created, awaiting client approval
  ACTIVE     // Client accepted, work in progress
  DONE       // End date reached, awaiting invoice payment
  CLOSED     // Invoice paid, project complete
  CANCELLED  // Cancelled
}

// Project - represents a contract for a branch
model Project {
  id            String        @id @default(cuid())
  branchId      String
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        ProjectStatus @default(PENDING)
  priority      RequestPriority @default(MEDIUM)
  startDate     DateTime?     // Contract start date
  endDate       DateTime?     // Contract end date
  autoRenew     Boolean       @default(false)
  totalValue    Float         @default(0)
  createdById   String
  createdByRole UserRole
  completedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Related modules
  requests     Request[]
  quotations   Quotation[]
  appointments Appointment[]
  invoices     Invoice[]
  contracts    Contract[]
  checklists   Checklist[]
  activities   Activity[]
  certificates Certificate[]
}

// Request priorities and statuses
enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  REQUESTED           // Client submitted, waiting for contractor
  QUOTED              // Contractor set date & price, waiting for client
  SCHEDULED           // Client accepted, work order created
  IN_PROGRESS         // Technician working
  FOR_REVIEW          // Work done, pending supervisor review
  PENDING_APPROVAL    // Waiting final client approval
  COMPLETED           // Done
  CLOSED              // Archived
  REJECTED            // Client rejected quote
  CANCELLED           // Cancelled by either party
}

// Service Request - created by contractor or client for a branch
model Request {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title         String
  description   String?
  priority      RequestPriority @default(MEDIUM)
  status        RequestStatus   @default(REQUESTED)
  createdById   String
  createdByRole UserRole
  assignedTo    String?
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // New fields for improved request flow
  workOrderType       WorkOrderType?  // Service, Inspection, Maintenance, etc.
  preferredDate       DateTime?       // Client's preferred date
  preferredTimeSlot   String?         // "Morning", "Afternoon", "Evening"
  recurringType       RecurringType   @default(ONCE)  // Once, Monthly, Quarterly
  needsCertificate    Boolean         @default(false) // Auto-generate certificate on completion
  
  // Contractor quote fields
  quotedPrice         Float?          // Price quoted by contractor
  quotedDate          DateTime?       // Date set by contractor
  quotedById          String?         // Contractor who quoted
  quotedAt            DateTime?       // When quote was sent
  
  // Client response
  acceptedAt          DateTime?       // When client accepted
  acceptedById        String?         // Client who accepted
  rejectedAt          DateTime?       // When client rejected
  rejectedById        String?         // Client who rejected
  rejectionNote       String?         // Reason for rejection
  
  // Link to created work order
  workOrderId         String?         // ChecklistItem ID once accepted
  
  // Photos
  photos              RequestPhoto[]
  
  // Comments
  comments            RequestComment[]
}

// Photos attached to service requests
model RequestPhoto {
  id          String   @id @default(cuid())
  requestId   String
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  url         String
  caption     String?
  createdAt   DateTime @default(now())
}

// Comments on service requests - visible to both client and contractor
model RequestComment {
  id          String   @id @default(cuid())
  requestId   String
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  content     String
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isEdited    Boolean  @default(false)
}

// Quotation statuses
enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
}

// Quotation - created by contractor for client approval
model Quotation {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  requestId     String?
  title         String
  description   String?
  items         QuotationItem[]
  subtotal      Float           @default(0)
  taxRate       Float           @default(0)
  taxAmount     Float           @default(0)
  total         Float           @default(0)
  status        QuotationStatus @default(DRAFT)
  validUntil    DateTime?
  sentAt        DateTime?
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  rejectionNote String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Quotation line items
model QuotationItem {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  description String
  quantity    Float     @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Appointment statuses
enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

// Appointment - scheduled visits/inspections
model Appointment {
  id              String            @id @default(cuid())
  branchId        String
  branch          Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId       String?
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title           String
  description     String?
  date            DateTime
  startTime       String
  endTime         String?
  duration        Int?              // Duration in minutes
  assignedTo      String?
  status          AppointmentStatus @default(SCHEDULED)
  confirmedAt     DateTime?
  confirmedById   String?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelledById   String?
  cancellationNote String?
  rescheduleNote  String?
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

// Invoice statuses
enum InvoiceStatus {
  DRAFT
  SENT
  PAYMENT_PENDING  // Client submitted payment proof, awaiting confirmation
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// Invoice - created by contractor for payment
model Invoice {
  id            String        @id @default(cuid())
  branchId      String
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  quotationId   String?
  invoiceNumber String?
  title         String
  description   String?
  items         InvoiceItem[]
  subtotal      Float         @default(0)
  taxRate       Float         @default(0)
  taxAmount     Float         @default(0)
  total         Float         @default(0)
  amountPaid    Float         @default(0)
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  sentAt        DateTime?
  paidAt        DateTime?
  // Payment proof fields
  paymentProofUrl       String?   // URL to uploaded file or external link
  paymentProofType      String?   // 'file' or 'link'
  paymentProofFileName  String?   // Original filename if file upload
  paymentSubmittedAt    DateTime? // When client submitted payment proof
  paymentSubmittedById  String?   // User who submitted payment proof
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// Invoice line items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Contract statuses
enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE  // Awaiting client start signature
  SIGNED             // Client signed start, project active
  COMPLETED          // Client signed end, project done
  EXPIRED
  TERMINATED
}

// Contract - service agreements for projects
model Contract {
  id                  String         @id @default(cuid())
  branchId            String
  branch              Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId           String?
  project             Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title               String
  description         String?
  fileName            String?        // PDF attachment file name
  fileUrl             String?        // PDF attachment URL
  fileSize            Int?
  certificateFileName String?        // Certificate file name
  certificateUrl      String?        // Certificate URL
  startSignatureUrl   String?        // Client start signature image
  startSignedById     String?        // User who signed at start
  startSignedAt       DateTime?      // When client signed at start
  endSignatureUrl     String?        // Client end signature image
  endSignedById       String?        // User who signed at end
  endSignedAt         DateTime?      // When client signed at end
  totalValue          Float          @default(0)
  startDate           DateTime?
  endDate             DateTime?
  status              ContractStatus @default(DRAFT)
  createdById         String
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// Checklist statuses
enum ChecklistStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

// Checklist item stages (for Kanban board)
enum ChecklistItemStage {
  REQUESTED      // Client submitted ad-hoc request
  SCHEDULED      // Task confirmed with date
  IN_PROGRESS    // Technician working on it
  FOR_REVIEW     // Work done, awaiting client confirmation
  COMPLETED      // Task closed
}

// Checklist item types
enum ChecklistItemType {
  SCHEDULED      // Part of original contract
  ADHOC          // Added during contract period
}

// Payment status for work orders
enum PaymentStatus {
  UNPAID                // Not yet paid
  PENDING_VERIFICATION  // Client submitted proof, awaiting contractor verification
  PAID                  // Contractor verified payment
}

// Recurring frequency for work orders
enum RecurringType {
  ONCE           // One-time work order
  MONTHLY        // Repeats every month
  QUARTERLY      // Repeats every 3 months
}

// Checklist - inspection checklists created by contractor
model Checklist {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title         String
  description   String?
  items         ChecklistItem[]
  status        ChecklistStatus @default(DRAFT)
  completedAt   DateTime?
  completedById String?
  notes         String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Checklist items (Work Orders)
model ChecklistItem {
  id              String             @id @default(cuid())
  checklistId     String
  checklist       Checklist          @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  description     String
  notes           String?
  stage           ChecklistItemStage @default(SCHEDULED)
  type            ChecklistItemType  @default(SCHEDULED)
  workOrderType   WorkOrderType?     // Service, Inspection, Maintenance, etc.
  recurringType   RecurringType      @default(ONCE)
  parentItemId    String?            // For recurring: links to original work order
  occurrenceIndex Int?               // For recurring: which occurrence (1, 2, 3...)
  scheduledDate   DateTime?
  price           Float?
  isCompleted     Boolean            @default(false)
  order           Int                @default(0)
  
  // Link to original request (if created from request)
  linkedRequestId String?            // Request ID that created this work order
  
  // Inspection Report Fields
  inspectionDate        DateTime?     // When inspection was performed
  systemsChecked        Json?         // Array of systems inspected ["Fire Alarm", "Sprinklers", ...]
  findings              String?       // What was observed
  deficiencies          String?       // Problems found
  recommendations       String?       // What should be done
  
  // Signatures
  technicianSignature   String?       // URL to technician signature image
  technicianSignedAt    DateTime?     // When technician signed
  technicianSignedById  String?       // Technician user ID
  supervisorSignature   String?       // URL to supervisor signature image
  supervisorSignedAt    DateTime?     // When supervisor signed
  supervisorSignedById  String?       // Supervisor user ID
  clientSignature       String?       // URL to client signature image (accepting work)
  clientSignedAt        DateTime?     // When client signed
  clientSignedById      String?       // Client user ID who signed
  
  // Report generation
  reportGeneratedAt     DateTime?     // When PDF report was generated
  reportUrl             String?       // URL to generated report PDF
  
  // Photos
  photos                InspectionPhoto[]
  
  // Payment tracking
  paymentStatus           PaymentStatus  @default(UNPAID)
  paymentProofUrl         String?        // URL to uploaded image/PDF or external link
  paymentProofType        String?        // 'file' or 'link'
  paymentProofFileName    String?        // Original filename if file upload
  paymentSubmittedAt      DateTime?      // When client submitted payment proof
  paymentSubmittedById    String?        // User ID who submitted payment
  paymentVerifiedAt       DateTime?      // When contractor verified payment
  paymentVerifiedById     String?        // User ID who verified payment
  paymentVerifiedSignature String?       // Contractor signature (base64 image) for verification
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

// Photos attached to work order inspections
model InspectionPhoto {
  id              String        @id @default(cuid())
  checklistItemId String
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)
  url             String
  caption         String?
  photoType       String?       // "before", "during", "after"
  createdAt       DateTime      @default(now())
}

// Certificates - auto-generated or uploaded
model Certificate {
  id          String          @id @default(cuid())
  branchId    String
  branch      Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  workOrderId String?         // Link to specific work order if applicable
  type        CertificateType
  title       String
  description String?
  fileUrl     String          // URL to certificate PDF
  issueDate   DateTime
  expiryDate  DateTime?
  issuedBy    String?         // Who issued (contractor name or "Civil Defense")
  issuedById  String?         // User ID who created/uploaded
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Activity types for tracking
enum ActivityType {
  COMMENT
  STATUS_CHANGE
  CREATED
  UPDATED
  APPROVED
  REJECTED
  COMPLETED
}

// Activity - comments and activity log for projects
model Activity {
  id          String       @id @default(cuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        ActivityType
  content     String?
  metadata    String?      // JSON string for additional data
  createdById String
  createdByRole UserRole
  createdAt   DateTime     @default(now())
}

// Branch Request statuses
enum BranchRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Branch Request - client requests a new branch for contractor approval
model BranchRequest {
  id            String              @id @default(cuid())
  clientId      String
  client        Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name          String
  address       String
  city          String?
  state         String?
  zipCode       String?
  country       String?
  phone         String?
  notes         String?
  latitude      Float?
  longitude     Float?
  status        BranchRequestStatus @default(PENDING)
  rejectionNote String?
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  createdById   String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

// Notification types
enum NotificationType {
  WORK_ORDER_REMINDER    // Upcoming work order reminder
  WORK_ORDER_STARTED     // Work order moved to IN_PROGRESS
  WORK_ORDER_FOR_REVIEW  // Work order sent for review
  WORK_ORDER_COMPLETED   // Work order completed
  PAYMENT_SUBMITTED      // Client submitted payment proof
  PAYMENT_VERIFIED       // Contractor verified payment
  CONTRACT_SIGNED        // Client signed contract
  CONTRACT_EXPIRING      // Contract expiring soon
  PROJECT_APPROVED       // Client approved project
  REQUEST_RECEIVED       // New request from client
  REQUEST_COMMENT        // New comment on a request
  GENERAL                // General notification
}

// Notification model for scheduled and triggered notifications
model Notification {
  id            String           @id @default(cuid())
  userId        String           // User to notify
  type          NotificationType
  title         String
  message       String
  link          String?          // Optional link to navigate to
  isRead        Boolean          @default(false)
  relatedId     String?          // Related entity ID (work order, contract, etc.)
  relatedType   String?          // Type of related entity
  createdAt     DateTime         @default(now())
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

// Team Member - contractor's staff (supervisors and technicians)
model TeamMember {
  id            String          @id @default(cuid())
  userId        String          @unique
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  contractorId  String
  contractor    Contractor      @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  teamRole      TeamMemberRole
  jobTitle      String?
  phone         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Which branches this team member can access
  branchAccess  TeamMemberBranch[]
}

// Junction table for TeamMember <-> Branch many-to-many relationship
model TeamMemberBranch {
  id            String      @id @default(cuid())
  teamMemberId  String
  teamMember    TeamMember  @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  branchId      String
  branch        Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([teamMemberId, branchId])
}
