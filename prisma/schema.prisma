generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CONTRACTOR
  CLIENT
}

enum UserStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  password       String
  name           String?
  role           UserRole   @default(CONTRACTOR)
  status         UserStatus @default(PENDING)
  emailVerified  DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Contractor-specific relations
  contractor     Contractor?
  
  // Client-specific relations
  client         Client?
}

model Contractor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName   String?
  companyPhone  String?
  companyEmail  String?
  companyAddress String?
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clients       Client[]
}

model Client {
  id            String     @id @default(cuid())
  userId        String     @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  companyName   String
  companyPhone  String?
  companyEmail  String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  branches        Branch[]
  branchRequests  BranchRequest[]
}

model Branch {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  address     String
  city        String?
  state       String?
  zipCode     String?
  country     String?
  phone       String?
  notes       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Module relations
  projects     Project[]
  requests     Request[]
  quotations   Quotation[]
  appointments Appointment[]
  invoices     Invoice[]
  contracts    Contract[]
  checklists   Checklist[]
}

// Project statuses - simplified for contract lifecycle
enum ProjectStatus {
  PENDING    // Created, awaiting client approval
  ACTIVE     // Client accepted, work in progress
  DONE       // End date reached, awaiting invoice payment
  CLOSED     // Invoice paid, project complete
  CANCELLED  // Cancelled
}

// Project - represents a contract for a branch
model Project {
  id            String        @id @default(cuid())
  branchId      String
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        ProjectStatus @default(PENDING)
  priority      RequestPriority @default(MEDIUM)
  startDate     DateTime?     // Contract start date
  endDate       DateTime?     // Contract end date
  autoRenew     Boolean       @default(false)
  totalValue    Float         @default(0)
  createdById   String
  createdByRole UserRole
  completedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Related modules
  requests     Request[]
  quotations   Quotation[]
  appointments Appointment[]
  invoices     Invoice[]
  contracts    Contract[]
  checklists   Checklist[]
  activities   Activity[]
}

// Request priorities and statuses
enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Service Request - created by contractor or client for a branch
model Request {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title         String
  description   String?
  priority      RequestPriority @default(MEDIUM)
  status        RequestStatus   @default(OPEN)
  createdById   String
  createdByRole UserRole
  assignedTo    String?
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Quotation statuses
enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
}

// Quotation - created by contractor for client approval
model Quotation {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  requestId     String?
  title         String
  description   String?
  items         QuotationItem[]
  subtotal      Float           @default(0)
  taxRate       Float           @default(0)
  taxAmount     Float           @default(0)
  total         Float           @default(0)
  status        QuotationStatus @default(DRAFT)
  validUntil    DateTime?
  sentAt        DateTime?
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  rejectionNote String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Quotation line items
model QuotationItem {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  description String
  quantity    Float     @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Appointment statuses
enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

// Appointment - scheduled visits/inspections
model Appointment {
  id              String            @id @default(cuid())
  branchId        String
  branch          Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId       String?
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title           String
  description     String?
  date            DateTime
  startTime       String
  endTime         String?
  duration        Int?              // Duration in minutes
  assignedTo      String?
  status          AppointmentStatus @default(SCHEDULED)
  confirmedAt     DateTime?
  confirmedById   String?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelledById   String?
  cancellationNote String?
  rescheduleNote  String?
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

// Invoice statuses
enum InvoiceStatus {
  DRAFT
  SENT
  PAYMENT_PENDING  // Client submitted payment proof, awaiting confirmation
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// Invoice - created by contractor for payment
model Invoice {
  id            String        @id @default(cuid())
  branchId      String
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  quotationId   String?
  invoiceNumber String?
  title         String
  description   String?
  items         InvoiceItem[]
  subtotal      Float         @default(0)
  taxRate       Float         @default(0)
  taxAmount     Float         @default(0)
  total         Float         @default(0)
  amountPaid    Float         @default(0)
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  sentAt        DateTime?
  paidAt        DateTime?
  // Payment proof fields
  paymentProofUrl       String?   // URL to uploaded file or external link
  paymentProofType      String?   // 'file' or 'link'
  paymentProofFileName  String?   // Original filename if file upload
  paymentSubmittedAt    DateTime? // When client submitted payment proof
  paymentSubmittedById  String?   // User who submitted payment proof
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// Invoice line items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Contract statuses
enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE  // Awaiting client start signature
  SIGNED             // Client signed start, project active
  COMPLETED          // Client signed end, project done
  EXPIRED
  TERMINATED
}

// Contract - service agreements for projects
model Contract {
  id                  String         @id @default(cuid())
  branchId            String
  branch              Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId           String?
  project             Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title               String
  description         String?
  fileName            String?        // PDF attachment file name
  fileUrl             String?        // PDF attachment URL
  fileSize            Int?
  certificateFileName String?        // Certificate file name
  certificateUrl      String?        // Certificate URL
  startSignatureUrl   String?        // Client start signature image
  startSignedById     String?        // User who signed at start
  startSignedAt       DateTime?      // When client signed at start
  endSignatureUrl     String?        // Client end signature image
  endSignedById       String?        // User who signed at end
  endSignedAt         DateTime?      // When client signed at end
  totalValue          Float          @default(0)
  startDate           DateTime?
  endDate             DateTime?
  status              ContractStatus @default(DRAFT)
  createdById         String
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// Checklist statuses
enum ChecklistStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

// Checklist item stages (for Kanban board)
enum ChecklistItemStage {
  REQUESTED      // Client submitted ad-hoc request
  SCHEDULED      // Task confirmed with date
  IN_PROGRESS    // Technician working on it
  FOR_REVIEW     // Work done, awaiting client confirmation
  COMPLETED      // Task closed
}

// Checklist item types
enum ChecklistItemType {
  SCHEDULED      // Part of original contract
  ADHOC          // Added during contract period
}

// Payment status for work orders
enum PaymentStatus {
  UNPAID                // Not yet paid
  PENDING_VERIFICATION  // Client submitted proof, awaiting contractor verification
  PAID                  // Contractor verified payment
}

// Recurring frequency for work orders
enum RecurringType {
  ONCE           // One-time work order
  MONTHLY        // Repeats every month
  QUARTERLY      // Repeats every 3 months
}

// Checklist - inspection checklists created by contractor
model Checklist {
  id            String          @id @default(cuid())
  branchId      String
  branch        Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title         String
  description   String?
  items         ChecklistItem[]
  status        ChecklistStatus @default(DRAFT)
  completedAt   DateTime?
  completedById String?
  notes         String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Checklist items (Work Orders)
model ChecklistItem {
  id              String             @id @default(cuid())
  checklistId     String
  checklist       Checklist          @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  description     String
  notes           String?
  stage           ChecklistItemStage @default(SCHEDULED)
  type            ChecklistItemType  @default(SCHEDULED)
  recurringType   RecurringType      @default(ONCE)
  parentItemId    String?            // For recurring: links to original work order
  occurrenceIndex Int?               // For recurring: which occurrence (1, 2, 3...)
  scheduledDate   DateTime?
  price           Float?
  isCompleted     Boolean            @default(false)
  order           Int                @default(0)
  
  // Payment tracking
  paymentStatus           PaymentStatus  @default(UNPAID)
  paymentProofUrl         String?        // URL to uploaded image/PDF or external link
  paymentProofType        String?        // 'file' or 'link'
  paymentProofFileName    String?        // Original filename if file upload
  paymentSubmittedAt      DateTime?      // When client submitted payment proof
  paymentSubmittedById    String?        // User ID who submitted payment
  paymentVerifiedAt       DateTime?      // When contractor verified payment
  paymentVerifiedById     String?        // User ID who verified payment
  paymentVerifiedSignature String?       // Contractor signature (base64 image) for verification
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

// Activity types for tracking
enum ActivityType {
  COMMENT
  STATUS_CHANGE
  CREATED
  UPDATED
  APPROVED
  REJECTED
  COMPLETED
}

// Activity - comments and activity log for projects
model Activity {
  id          String       @id @default(cuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        ActivityType
  content     String?
  metadata    String?      // JSON string for additional data
  createdById String
  createdByRole UserRole
  createdAt   DateTime     @default(now())
}

// Branch Request statuses
enum BranchRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Branch Request - client requests a new branch for contractor approval
model BranchRequest {
  id            String              @id @default(cuid())
  clientId      String
  client        Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name          String
  address       String
  city          String?
  state         String?
  zipCode       String?
  country       String?
  phone         String?
  notes         String?
  latitude      Float?
  longitude     Float?
  status        BranchRequestStatus @default(PENDING)
  rejectionNote String?
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  createdById   String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

// Notification types
enum NotificationType {
  WORK_ORDER_REMINDER    // Upcoming work order reminder
  WORK_ORDER_STARTED     // Work order moved to IN_PROGRESS
  WORK_ORDER_FOR_REVIEW  // Work order sent for review
  WORK_ORDER_COMPLETED   // Work order completed
  PAYMENT_SUBMITTED      // Client submitted payment proof
  PAYMENT_VERIFIED       // Contractor verified payment
  CONTRACT_SIGNED        // Client signed contract
  CONTRACT_EXPIRING      // Contract expiring soon
  PROJECT_APPROVED       // Client approved project
  REQUEST_RECEIVED       // New request from client
  GENERAL                // General notification
}

// Notification model for scheduled and triggered notifications
model Notification {
  id            String           @id @default(cuid())
  userId        String           // User to notify
  type          NotificationType
  title         String
  message       String
  link          String?          // Optional link to navigate to
  isRead        Boolean          @default(false)
  relatedId     String?          // Related entity ID (work order, contract, etc.)
  relatedType   String?          // Type of related entity
  createdAt     DateTime         @default(now())
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
}
